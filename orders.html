<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - Mobile Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg:#0f172a; --surface:#111827; --muted-surface:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --primary:#22d3ee; --primary-2:#6366f1; --danger:#ef4444; }
        body { background: var(--bg); color: var(--text); }
        .hero-section { background: radial-gradient(60% 80% at 70% 10%, rgba(99,102,241,0.25) 0%, rgba(99,102,241,0) 60%), linear-gradient(135deg, #0b1220 0%, #0f172a 50%, #0ea5e9 100%); color: var(--text); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 0; }
        .order-card { background: var(--surface); color: var(--text); border-radius: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.35); margin-bottom: 20px; overflow: hidden; }
        .order-header { background: var(--muted-surface); padding: 20px; border-bottom: 1px solid rgba(148,163,184,0.2); }
        .order-body { padding: 20px; }
        .status-badge { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        /* Keep existing status colors for contrast */
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-shipped { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .product-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(148,163,184,0.1); }
        .product-item:last-child { border-bottom: none; }
        .product-image { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-right: 15px; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
        .btn-outline-primary { color: var(--text); border-color: rgba(148,163,184,0.35); }
        .btn-outline-primary:hover { background: rgba(148,163,184,0.1); color: var(--text); border-color: rgba(148,163,184,0.55); }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="fas fa-mobile-alt"></i> Mobile Shop</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">Contact</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span id="userName">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user-circle"></i> Profile</a></li>
                            <li><a class="dropdown-item active" href="orders.html"><i class="fas fa-history"></i> Orders</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </li>
                    <li class="nav-item position-relative">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#cartModal">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-badge" id="cartBadge">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold mb-3">Order History</h1>
                    <p class="lead mb-0">Track your orders and view order details</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Orders Section -->
    <section class="py-5">
        <div class="container">
            <!-- Filter Section -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search orders..." id="orderSearch" onkeyup="filterOrders()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter" onchange="filterOrders()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="dateFilter" onchange="filterOrders()">
                        <option value="">All Time</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 3 months</option>
                    </select>
                </div>
            </div>

            <!-- Orders List -->
            <div id="ordersContainer">
                <!-- Orders will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetails">
                    <!-- Order details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printOrder()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="common.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadOrders();
            updateCartDisplay();
        });

        // Check authentication status
        function checkAuthStatus() {
            const user = localStorage.getItem('user');
            if (!user) {
                // Do not redirect in CTF mode; allow access as Guest
                const nameEl = document.getElementById('userName');
                if (nameEl) nameEl.textContent = 'Guest';
                return;
            }

            const userData = JSON.parse(user);
            document.getElementById('userName').textContent = userData.firstName || 'User';
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch('/api/user/orders', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    allOrders = await response.json();
                } else {
                    // Fallback to sample data
                    allOrders = getSampleOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                allOrders = getSampleOrders();
            }
            
            filteredOrders = [...allOrders];
            displayOrders();
        }

        // Get sample orders for demo
        function getSampleOrders() {
            return [
                {
                    id: 1,
                    orderNumber: 'ORD-2024-001',
                    date: '2024-01-15',
                    status: 'delivered',
                    total: 999.00,
                    items: [
                        {
                            id: 1,
                            name: 'iPhone 15 Pro',
                            price: 999,
                            quantity: 1,
                            image: 'https://via.placeholder.com/60x60?text=iPhone+15+Pro'
                        }
                    ],
                    shippingAddress: '123 Main St, City, State 12345',
                    trackingNumber: 'TRK123456789'
                },
                {
                    id: 2,
                    orderNumber: 'ORD-2024-002',
                    date: '2024-01-20',
                    status: 'shipped',
                    total: 1798.00,
                    items: [
                        {
                            id: 2,
                            name: 'Samsung Galaxy S24',
                            price: 899,
                            quantity: 2,
                            image: 'https://via.placeholder.com/60x60?text=Galaxy+S24'
                        }
                    ],
                    shippingAddress: '456 Oak Ave, City, State 12345',
                    trackingNumber: 'TRK987654321'
                },
                {
                    id: 3,
                    orderNumber: 'ORD-2024-003',
                    date: '2024-01-25',
                    status: 'processing',
                    total: 699.00,
                    items: [
                        {
                            id: 3,
                            name: 'Google Pixel 8',
                            price: 699,
                            quantity: 1,
                            image: 'https://via.placeholder.com/60x60?text=Pixel+8'
                        }
                    ],
                    shippingAddress: '789 Pine St, City, State 12345',
                    trackingNumber: null
                }
            ];
        }

        // Display orders
        function displayOrders() {
            const container = document.getElementById('ordersContainer');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-bag"></i>
                        <h4>No orders found</h4>
                        <p>You haven't placed any orders yet.</p>
                        <a href="products.html" class="btn btn-primary">
                            <i class="fas fa-shopping-cart"></i> Start Shopping
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            filteredOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                container.appendChild(orderCard);
            });
        }

        // Create order card
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';
            
            const statusClass = `status-${order.status}`;
            const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
            
            card.innerHTML = `
                <div class="order-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="mb-1">Order #${order.orderNumber}</h6>
                            <small class="text-muted">${new Date(order.date).toLocaleDateString()}</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="col-md-3 text-end">
                            <h6 class="mb-0">$${order.total.toFixed(2)}</h6>
                        </div>
                    </div>
                </div>
                <div class="order-body">
                    <div class="row">
                        <div class="col-md-8">
                            ${order.items.map(item => `
                                <div class="product-item">
                                    <img src="${item.image}" alt="${item.name}" class="product-image">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${item.name}</h6>
                                        <small class="text-muted">Qty: ${item.quantity} × $${item.price}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm mb-2" onclick="viewOrderDetails(${order.id})">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${order.status === 'delivered' ? `
                                <button class="btn btn-outline-success btn-sm mb-2" onclick="reorder(${order.id})">
                                    <i class="fas fa-redo"></i> Reorder
                                </button>
                            ` : ''}
                            ${order.status === 'pending' || order.status === 'processing' ? `
                                <button class="btn btn-outline-danger btn-sm" onclick="cancelOrder(${order.id})">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-warning btn-sm" onclick="deleteOrder(${order.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // View order details
        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const modalBody = document.getElementById('orderDetails');
            modalBody.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <p><strong>Order Number:</strong> ${order.orderNumber}</p>
                        <p><strong>Order Date:</strong> ${new Date(order.date).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Shipping Address</h6>
                        <p>${order.shippingAddress}</p>
                        ${order.trackingNumber ? `<p><strong>Tracking:</strong> ${order.trackingNumber}</p>` : ''}
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="${item.image}" alt="${item.name}" class="product-image me-2">
                                            ${item.name}
                                        </div>
                                    </td>
                                    <td>$${item.price}</td>
                                    <td>${item.quantity}</td>
                                    <td>$${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3">Total</th>
                                <th>$${order.total.toFixed(2)}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('orderModal'));
            modal.show();
        }

        // Filter orders
        function filterOrders() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredOrders = allOrders.filter(order => {
                let matchesSearch = true;
                let matchesStatus = true;
                let matchesDate = true;

                if (searchTerm) {
                    matchesSearch = order.orderNumber.toLowerCase().includes(searchTerm) ||
                                   order.items.some(item => item.name.toLowerCase().includes(searchTerm));
                }

                if (statusFilter) {
                    matchesStatus = order.status === statusFilter;
                }

                if (dateFilter) {
                    const orderDate = new Date(order.date);
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - parseInt(dateFilter));
                    matchesDate = orderDate >= daysAgo;
                }

                return matchesSearch && matchesStatus && matchesDate;
            });

            displayOrders();
        }

        // Refresh orders
        function refreshOrders() {
            loadOrders();
            showNotification('Orders refreshed!', 'success');
        }

        // Reorder
        function reorder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            // Add items to cart
            order.items.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    addToCart(item.id);
                }
            });

            showNotification('Items added to cart!', 'success');
            setTimeout(() => {
                window.location.href = 'products.html';
            }, 1000);
        }

        // Cancel order
        function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'cancelled';
                    displayOrders();
                    showNotification('Order cancelled successfully!', 'success');
                }
            }
        }

        // Print order
        function printOrder() {
            window.print();
        }

        // Delete order (CSRF vulnerable)
        async function deleteOrder(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                        // VULNERABLE: No CSRF token included
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Check if this is a vulnerability flag response
                    if (data.flag) {
                        showVulnerabilityFlag(data);
                        return;
                    }
                    
                    showNotification('Order deleted successfully!', 'success');
                    loadOrders(); // Reload orders
                } else {
                    showNotification('Failed to delete order', 'error');
                }
            } catch (error) {
                console.error('Delete order error:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Update cart display
        function updateCartDisplay() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const badge = document.getElementById('cartBadge');
            if (badge) {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                badge.textContent = totalItems;
                badge.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }

        // Add to cart function (from script.js)
        function addToCart(productId) {
            // This would normally fetch product data and add to cart
            // For demo purposes, we'll just show a notification
            showNotification('Item added to cart!', 'success');
        }

        // Show vulnerability flag
        function showVulnerabilityFlag(data) {
            const flagModal = document.createElement('div');
            flagModal.className = 'modal fade';
            flagModal.id = 'flagModal';
            flagModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-flag"></i> Vulnerability Exploited!
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success">
                                <h4><i class="fas fa-trophy"></i> Flag Captured!</h4>
                                <h2 class="text-center text-primary">${data.flag}</h2>
                            </div>
                            <h5>Vulnerability: ${data.vulnerability}</h5>
                            <p>${data.description}</p>
                            ${data.deleted_order_id ? `<p><strong>Deleted Order ID:</strong> ${data.deleted_order_id}</p>` : ''}
                            <p><strong>Exploit Type:</strong> ${data.exploit_type}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(flagModal);
            const modal = new bootstrap.Modal(flagModal);
            modal.show();
            
            // Remove modal from DOM when hidden
            flagModal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(flagModal);
            });
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> 
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
